<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Kết quả</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
      .area { white-space: pre-wrap; }
      .toolbar { display: flex; gap: .5rem; flex-wrap: wrap; }
    </style>
  </head>
  <body>
    <main class="container">
      <h1>Nhận dạng & Dịch</h1>

      <section>
        <div class="toolbar">
          <button id="toggle">Hiển thị: {{ 'Tiếng Việt' if vi_text else 'Tiếng Anh' }}</button>
          <button id="copy">Copy</button>
          <button id="downloadCurrent">Tải xuống đang hiển thị</button>
          {% if vi_text %}
          <button id="downloadEn">Tải EN</button>
          <button id="downloadVi">Tải VI</button>
          {% endif %}
          <a href="/" role="button" class="contrast">Dịch file khác</a>
          {% if not vi_text %}
          <form action="/translate" method="post" style="display:inline">
            <input type="hidden" name="en_text" value="{{ en_text }}" />
            <button type="submit">Dịch sang tiếng Việt</button>
          </form>
          {% endif %}
        </div>

        <article>
          <h3 id="title">{{ 'Tiếng Việt' if vi_text else 'Tiếng Anh' }}</h3>
          <div id="content" class="area">{{ vi_text if vi_text else en_text }}</div>
        </article>

        {% if vi_text %}
        <details>
          <summary>Hiển thị cả hai</summary>
          <div class="grid">
            <article>
              <h4>Tiếng Anh</h4>
              <div class="area">{{ en_text }}</div>
            </article>
            <article>
              <h4>Tiếng Việt</h4>
              <div class="area">{{ vi_text }}</div>
            </article>
          </div>
        </details>
        {% endif %}
      </section>

      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <article>
            {% for msg in messages %}
              <p>{{ msg }}</p>
            {% endfor %}
          </article>
        {% endif %}
      {% endwith %}
    </main>

    <script>
      const enText = `{{ en_text | replace('`','\`') }}`;
      const viText = `{{ (vi_text or '') | replace('`','\`') }}`;
      const hasVi = {{ 'true' if vi_text else 'false' }};
      const titleEl = document.getElementById('title');
      const contentEl = document.getElementById('content');
      const toggleBtn = document.getElementById('toggle');
      const copyBtn = document.getElementById('copy');
      const dlCurrentBtn = document.getElementById('downloadCurrent');
      const dlEnBtn = document.getElementById('downloadEn');
      const dlViBtn = document.getElementById('downloadVi');
      let showingVi = hasVi;

      function downloadText(filename, text) {
        const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
          if (!hasVi) return;
          showingVi = !showingVi;
          titleEl.textContent = showingVi ? 'Tiếng Việt' : 'Tiếng Anh';
          contentEl.textContent = showingVi ? viText : enText;
        });
      }

      copyBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(contentEl.textContent);
          copyBtn.textContent = 'Đã copy';
          setTimeout(() => copyBtn.textContent = 'Copy', 1500);
        } catch {}
      });

      dlCurrentBtn.addEventListener('click', () => {
        const isVi = hasVi && showingVi;
        const name = isVi ? 'transcript.vi.txt' : 'transcript.en.txt';
        downloadText(name, contentEl.textContent);
      });

      if (dlEnBtn) dlEnBtn.addEventListener('click', () => downloadText('transcript.en.txt', enText));
      if (dlViBtn) dlViBtn.addEventListener('click', () => downloadText('transcript.vi.txt', viText));
    </script>
  </body>
</html>
